---
title: "Analyze ESAS questionnaire for draft report"
author: "Lien Reyserhove"
output: html_document
---

# General settings

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

Load libraries

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(magrittr)
library(here)
library(knitr)
library(formattable)
library(sf)
library(leaflet)
library(htmltools)
library(htmlwidgets)
library(webshot)
library(kableExtra)
```

# Import data

```{r import data}
input_data <- read.delim(file = here::here("data", "intermediate", "input_data_cleaned.csv"), sep = ",")
```

Define level order for sorting in tables:

```{r}
input_data %<>% 
  mutate(programme_id = factor(programme_id,
         levels = c(
           "FIN-SYKE", "FIN-MNH",
           "EST-EMU", "EST-EOS",
           "LVA-GOR", "LVA-LIFE05", "LVA-MAR", "LVA-WWAS",
           "LTU",
           "RUS",
           "POL-MZPM",
           "SWE",
           "DNK",
           "DEU-BSH", "DEU-GMBM", "DEU-OSMS", "DEU-SAS",
           "NOR-NINA",
           "NLD-BuWa-AIR", "NLD-BuWa-SHIP", "NLD-MWTL", "NLD-NIOZ", "NLD-WUR",
           "BEL-INBO", "BEL-RBINS",
           "GBR-HIDEF", "GBR-JNCC", "GBR-OWF", "GBR-SFF",
           "IRL-MI", "IRL-NPWS",
           "FRA", 
           "ESP-AV3", "ESP-BIO", "ESP-JUV", "ESP-PEL", "ESP-UCA",
           "PRT",
           "GRC-HSP", "GRC-LIFE03", "GRC-LIFE07", "GRC-LIFE96", "GRC-MSFD",
           "MLT")))
```

Import spatial information data for map:

```{r import geojson}
global_countries_spatial <- st_read(here::here("./data/input/CNTR_RG_60M_2020_4326.geojson"))
```

# Paragraph 1: General programme information

## Statistics for text

Total number of programmes:

```{r}
input_data %>% nrow()
```

Total number of organizations:

```{r}
input_data %>% distinct(organization_acronym) %>% count()
```

## Figure 1: Number of datasets per country

Generate `datasets_per_country`

```{r}
datasets_per_country <- 
  input_data %>% 
    select(country_clean) %>% 
    group_by(country_clean) %>% 
    summarize(n_datasets = n())
datasets_per_country
```

filter spatial information on countries of interest

```{r}
focal_countries_spatial <- 
  global_countries_spatial %>% 
    filter(NAME_ENGL %in% input_data$country_clean)
```

Join information with `countries_spatial`

```{r}
focal_countries_spatial %<>% 
  left_join(datasets_per_country,
            by = c("NAME_ENGL" = "country_clean"))
```

Plot information:

```{r}
bins <- c(1, 2, 3, 4, 5,6)
labels <- c("1", "2", "3", "4", "5","6")
binpal <- colorBin("YlOrRd", domain = focal_countries_spatial$n_datasets, bins = bins)

figure_1 <-
  leaflet(focal_countries_spatial) %>%
  setView(lng = 9,
          lat = 51,
          zoom = 3.75) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~binpal(n_datasets),
    weight = 2,
    opacity = 1,
    color = "grey",
    dashArray = "3",
    fillOpacity = 1,
    label = ~htmlEscape(n_datasets)) %>%
  addLegend("bottomright",
            pal = binpal, values = ~n_datasets,
            title = "number of SAS datasets",
            opacity = 1,
            labFormat = function(type, cuts, p)
              {paste0(labels)})
figure_1
```

Save html via Export -> Save as web page or via saveWidget:

```{r}
saveWidget(figure_1,
           "figure_1.html",
           selfcontained = TRUE)
```

```{r}
webshot("figure_1.html",
        file = "../data/processed/figure_1.png",
        cliprect = "viewport")
```

## Table 1: General project information

This table discusses the following programme properties:

- Programme ID
- Country
- Organization (acronym)
- Programme name and/or acronym

```{r}
table_1 <- 
  input_data %>%
      select(programme_id, country_clean, organization_acronym, programme_acronym) %>% 
  rename(`Programme ID` = programme_id) %>%
  rename(`Country` = country_clean,
         `Organization` = organization_acronym,
         `Programme name/acronym` = programme_acronym) %>% 
  arrange(`Programme ID`)
kbl(table_1)
```

Export as .tsv

```{r}
write_tsv(table_1, path = here::here("data", "processed", "table_1.tsv"))
```

# Paragraph 2: Data content

This table should include:

- Programme active (y/n)
- Nr of occurrences 
- Geographical coverage
- Taxonomic Coverage
- Platform

## Clean data

### Number of occurrences

```{r}
input_data %>% 
  select(nr_occurrences) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

Clean values:

```{r}
input_data %<>% 
  mutate(nr_occurrences_clean = recode(nr_occurrences,
    "1-10.000" = "1-10K",
    "10.000 - 100.000" = "10K-100K",
    "100.000 - 1.000.000" = "100K-1M",
    ">1.000.000" = ">1M",
    "Unknown" = ""))
```

Compare `nr_occurrences` with `nr_occurrences_clean`

```{r}
input_data %>% 
  select(nr_occurrences, nr_occurrences_clean) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

### Geographical scope

Inspect values

```{r}
input_data %>% 
  select(geographical_scope) %>% 
  group_by_all() %>% 
  summarize(records = n()) %>% 
  kbl()
```

Make new columns `OSPAR`, `HELCOM` and `Other`:

```{r}
input_data %<>% 
  mutate(ospar = recode(geographical_scope,
    "Arctic waters (OSPAR Region I)" = "I",
    "Arctic waters (OSPAR Region I), Greater North Sea (OSPAR Region II), Bay of Biscay and Iberian Coast (OSPAR Region IV), Wider Atlantic (OSPAR Region V), Tropics" = "I,II,IV,V",
    "Arctic waters (OSPAR Region I), Greater North Sea (OSPAR Region II), Celtic Seas (OSPAR Region III), Bay of Biscay and Iberian Coast (OSPAR Region IV)" = "I, II, III, IV",
   "Baltic Sea" = "",
   "Baltic Sea, The Gulf of Finland of Baltic Sea" = "",
   "Bay of Biscay and Iberian Coast (OSPAR Region IV)" = "IV",
   "Bay of Biscay and Iberian Coast (OSPAR Region IV), Only shelf Spanish waters in the N and NW of the Iberian Coast" = "IV",
   "Bay of Biscay and Iberian Coast (OSPAR Region IV), Wider Atlantic (OSPAR Region V)" = "IV,V",
   "Celtic Seas (OSPAR Region III)" = "III",
   "East Mediterranean" = "",
   "Greater North Sea (OSPAR Region II)" = "II",
   "Greater North Sea (OSPAR Region II), Baltic Sea, DK EEZ of the above" = "II",
   "Greater North Sea (OSPAR Region II), Baltic Sea" = "II",
   "Greater North Sea (OSPAR Region II), Celtic Seas (OSPAR Region III)" = "II,III",
   "Greater North Sea (OSPAR Region II), Celtic Seas (OSPAR Region III), Bay of Biscay and Iberian Coast (OSPAR Region IV)" = "II,III,IV",
   "The Irish EEZ" = "II,III",
   "UK waters" = "II,III"
    ))
```

Helcom areas:

```{r}
input_data %<>% 
  mutate(baltic_sea = recode(geographical_scope,
    "Arctic waters (OSPAR Region I)" = "",
    "Arctic waters (OSPAR Region I), Greater North Sea (OSPAR Region II), Bay of Biscay and Iberian Coast (OSPAR Region IV), Wider Atlantic (OSPAR Region V), Tropics" = "",
    "Arctic waters (OSPAR Region I), Greater North Sea (OSPAR Region II), Celtic Seas (OSPAR Region III), Bay of Biscay and Iberian Coast (OSPAR Region IV)" = "",
   "Baltic Sea" = "yes",
   "Baltic Sea, The Gulf of Finland of Baltic Sea" = "yes",
   "Bay of Biscay and Iberian Coast (OSPAR Region IV)" = "",
   "Bay of Biscay and Iberian Coast (OSPAR Region IV), Only shelf Spanish waters in the N and NW of the Iberian Coast" = "",
   "Bay of Biscay and Iberian Coast (OSPAR Region IV), Wider Atlantic (OSPAR Region V)" = "",
   "Celtic Seas (OSPAR Region III)" = "",
   "East Mediterranean" = "",
   "Greater North Sea (OSPAR Region II)" = "",
   "Greater North Sea (OSPAR Region II), Baltic Sea" = "yes",
   "Greater North Sea (OSPAR Region II), Baltic Sea, DK EEZ of the above" = "yes",
   "Greater North Sea (OSPAR Region II), Celtic Seas (OSPAR Region III)" = "",
   "Greater North Sea (OSPAR Region II), Celtic Seas (OSPAR Region III), Bay of Biscay and Iberian Coast (OSPAR Region IV)" = "",
   "The Irish EEZ" = "",
   "UK waters" = ""
    ))
```

Inspect new values:

```{r}
input_data %>% 
  select(geographical_scope, ospar, baltic_sea) %>% 
  group_by_all() %>% 
  summarize(records = n()) %>% 
  kbl()
```

### Taxonomic Coverage

Inspect values:

```{r}
input_data %>% 
  select(taxonomic_scope) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

Separate into `birds_yn`, `marine_mammals_yn`, `other`:

```{r}
input_data %<>%
  separate(taxonomic_scope,
             into = c("birds_yn", "marine_mammals_yn", "other"),
             sep = ", ",
             remove = FALSE)
```

Clean data:
- recode to yes/no for birds and marine mammals or empty if NA
- Clean `other` field

```{r}
input_data %<>% 
  mutate(other = case_when(
    birds_yn == "Multispecies" ~ "Multispecies", # add multispecies information to `other`
    TRUE ~ other)) %>% 
  mutate(birds_yn = "yes") %>%  # all datasets have birds
  mutate(marine_mammals_yn = case_when(
    marine_mammals_yn == "Marine mammals" ~ "yes", TRUE ~ "")) %>% 
  mutate(other = recode(other,
    "fish and turtles" = "Fish, turtles",
    "oceanography" = "Oceanography",
    "reptiles" = "Reptiles",
    "turtle" = "Turtles",
    .missing = "")) 
```

Summarize results

```{r}
input_data %>% 
  select(taxonomic_scope, birds_yn, marine_mammals_yn, other) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

### Temporal scope

Inspect `start_year` and `end_year`

```{r}
input_data %>% 
  select(start_year, end_year) %>% 
  group_by_all() %>% 
  summarize(n = n())
```

```{r}
input_data %<>% mutate(temporal_scope = case_when(
  active_yn == "Yes" ~ paste(start_year, "now",sep = "-"),
  active_yn == "No" ~ paste(start_year, end_year, sep ="-")))
```


```{r}
input_data %>% 
  select(start_year, end_year, temporal_scope) %>% 
  group_by_all() %>% 
  summarize(n = n())
```

### Platform

```{r}
input_data %>% 
  select(platform) %>% group_by_all() %>% summarize(n = n())
```

Generate two columns: `ship-based` and `aerial`

```{r}
input_data <- 
  input_data %>% 
    mutate(ship_based = case_when(
      platform == "Ship-based" |
        platform == "Ship-based, Aerial" ~ "yes",
      TRUE ~ "")) %>% 
    mutate(aerial = case_when(
       platform == "Aerial" |
        platform == "Ship-based, Aerial" ~ "yes",   
       TRUE ~ ""))
```

## Statistics for text

Some cleaning steps:

- Change `Relational database (Postgres, MySQL, etc.)` to `Relational database` as we will separate on `,` later:
**REMARK: code could be simplified, to do later**

```{r}
input_data <-
  input_data %>% mutate(data_storage = recode(data_storage,
    "Relational database (Postgres, MySQL, etc.)" = "Relational database",
    "Relational database (Postgres, MySQL, etc.), CSV files" = "Relational database, CSV files",
    "Relational database (Postgres, MySQL, etc.), Microsoft Excel" = "Relational database, Microsoft Excel"))
```

- Seperate `data_storage` into different units:

```{r}
data_storage <- 
  input_data %>% separate(col = data_storage, 
                            into = c("storage_1", "storage_2"),
                            sep = ",")
```

- From wide to long dataset:

```{r}
data_storage <-
  data_storage %>% 
  gather(key = key, value = value, storage_1: storage_2, na.rm = TRUE, factor_key = TRUE) %>% 
  select(key, value) %>% 
  mutate(value = str_trim(value, side = "left")) %>%    # trim whitespace
  mutate(value = recode(value, 
    "But since 2015 we are collecting data using electronic devices. A Cybertracker based App was built. Data is needed to be imported to Paradox though." = "Paradox"))  %>% # Recode long sentence to `Paradox` 
  mutate(value = factor(value, levels = c("CSV files", "Microsoft Excel", "Microsoft Access", "Paradox", "Relational database")))
```

- Recode `But since 2015 we are collecting data using electronic devices. A Cybertracker based App was built. Data is needed to be imported to Paradox though.`:

- Count records:

```{r}
data_storage <-
  data_storage %>% 
    select(value) %>% 
    group_by(value) %>% 
    summarize(records = n())
data_storage
```

## Table 2: Data content

This table should include:

- Programme ID
- Programme activity
- Nr of occurrences 
- Geographical coverage
- Taxonomic Coverage
- Platform

```{r}
table_2 <-
input_data %>% 
  select(programme_id, temporal_scope, nr_occurrences_clean, ospar, baltic_sea, 
         marine_mammals_yn, aerial, ship_based) %>% 
  rename(
    `Programme ID` = programme_id,
    `Nr of occurrences` = nr_occurrences_clean,
    `Temporal scope` = temporal_scope,
    `OSPAR region` = ospar,
    `Baltic Sea` = baltic_sea,
    `Marine mammals` = marine_mammals_yn,
    `Plane` = aerial,
    `Ship` = ship_based) %>% 
  arrange(`Programme ID`)
kbl(table_2)
```

```{r}
write_tsv(table_2, path = here::here("data", "processed", "table_2.tsv"))
```

# Paragraph 3: Constraints for sharing data

## Clean data

### Sharing interest

Screent content of `sharing_interest_yn`:

```{r}
input_data %>%
  select(sharing_interest_yn) %>% 
  group_by(sharing_interest_yn) %>% 
  summarize(records = n(),
            `?` = n()/nrow(input_data)*100)
```

No cleaning required

### Financial constraints

Screent content of `financial_constraints_yn`:

```{r}
input_data %>%
  select(financial_constraints_yn) %>% 
  group_by(financial_constraints_yn) %>% 
  summarize(records = n(),
            `?` = n()/nrow(input_data)*100)
```

### Legal constraints

```{r}
input_data %>%
  select(legal_constraints_yn) %>% 
  group_by(legal_constraints_yn) %>% 
  summarize(records = n(),
            `?` = n()/nrow(input_data)*100)
```

2## Statistics for text 

Integration in ESAs database? Summarize `esas_db_yn`:

```{r}
input_data %>% 
  select(esas_db_yn) %>% 
  group_by_all() %>% 
  summarize(records = n(),
            percentage = round(n()/nrow(input_data)*100))
```

Summary per country:

```{r}
input_data %>% 
  select(country_clean, esas_db_yn) %>% 
  group_by_all() %>% 
  summarize(records = n())
```


## Table 3

This table discusses the following dataset properties:

- Inclusion in ESAS db (y/n)
- Sharing interest (Y/n)
- Financial constraints (y/n)
- Legal constraints (y/n)

Generate table 3:

```{r}
table_3 <- 
  input_data %>% 
    select(programme_id, esas_db_yn, sharing_interest_yn, financial_constraints_yn, legal_constraints_yn) %>%
    rename(`Programme ID` = programme_id,
           `Inclusion ESAS DB` = esas_db_yn,
           `Sharing interest` = sharing_interest_yn,
           `financial constraints` = financial_constraints_yn,
           `legal constraints` = legal_constraints_yn) %>% 
    arrange(`Programme ID`) 
```


```{r}
write_tsv(table_3, path = here::here("data", "processed", "table_3.tsv"))
```




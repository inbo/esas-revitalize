---
title: "Analyze ESAS questionnaire for draft report"
author: "Lien Reyserhove"
date: "25 augustus 2020"
output: html_document
---


# General settings

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

Load libraries

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(magrittr)
library(here)
library(knitr)
library(formattable)
library(sf)
library(leaflet)
library(htmltools)
library(kableExtra)
```

# Import data

```{r import data}
input_data <- read.delim(file = here::here("data", "input", "input_data.csv"), sep = ",")
```

Import spatial information:

```{r}
global_countries_spatial <- st_read(here::here("./data/input/CNTR_RG_60M_2020_4326.geojson"))
```


# Clean data

Country data is essential in this analysis. Here we clean this information

```{r, eval=FALSE}
input_data %>% 
  select(country) %>% 
  group_by(country) %>% 
  summarize(records = n())
```

Steps:

- Seperate `Norway and Russia`:

```{r}
input_data %<>% 
  separate(country, 
           into = c("country_1", "country_2"),
           sep = " and ") %>% 
  gather(key = "key",
         value = "country",
         country_1, country_2,
         na.rm = TRUE)
```

- Recode names to match with `global_countries_spatial`:

```{r}
input_data %<>% mutate(country = recode(country, 
  "Eesti" = "Estonia", 
  "Russia" = "Russian Federation",
  "UK" = "United Kingdom"))
```

- Clean country names: upper to lower case:

```{r}
input_data %<>% mutate(country = str_to_title(country))
```

Add ISO codes in `global_countries_spatial` to `input_data`

```{r}
input_data %<>% left_join(
  select(global_countries_spatial, NAME_ENGL, ISO3_CODE),
  by = c("country" = "NAME_ENGL")) 
```


# Graphs

## WHO has responded?

### Graph 1: Overview of total amount of datasets per country

Select on countries of interest:

```{r}
countries_spatial <-
  global_countries_spatial %>%
  filter(ISO3_CODE %in% input_data$ISO3_CODE)
```

Generate `datasets_per_country`

```{r}
datasets_per_country <- 
  input_data %>% 
    select(ISO3_CODE) %>% 
    group_by(ISO3_CODE) %>% 
    summarize(n_datasets = n())
```


Join information with `countries_spatial`

```{r}
countries_spatial %<>% 
  left_join(datasets_per_country,
            by = "ISO3_CODE")
```

Plot information:

```{r}
bins <- c(1, 2, 3, 4)
pal <- colorNumeric("YlOrRd", domain = countries_spatial$n_datasets)

map_datasets <-
  leaflet(countries_spatial) %>%
  setView(lng = 4.89,
          lat = 51.01,
          zoom = 4) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~pal(n_datasets),
    weight = 2,
    opacity = 1,
    color = "grey",
    dashArray = "3",
    fillOpacity = 1,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = ~htmlEscape(n_datasets)) %>%
  addLegend("bottomright",
            pal = pal, values = ~n_datasets,
            title = "Published datasets",
            opacity = 1)
map_datasets

```

VOEG HIER NOG EEN LAAT TO MET DATASETS WAARVOOR WE GEEN ANTWOORDEN KREGEN


### Table 1: Organizations + acronym


Generate table with organizations + acronyms

```{r}
organizations_acronyms <- 
  input_data %>% 
      mutate(country = recode(country, "United Kingdom" = "UK", "Russian Federation" = "Russia")) %>% 
      arrange(country) %>% 
      select(country, organization, name_and_acronym) %>% 
      kbl() %>% 
      kable_classic(full_width = T, html_font = "Arial") %>% 
      kable_styling(bootstrap_options = c("striped", "hover")) 
```

```{r}
organizations_acronyms %>% as_image(file = "../test.png")
```

This analysis will only focus on SAS data
--> remove non-SAS responses:

```{r remove non sas data}
input_data %<>% filter(sas_data_yn != "No")
```

## Data compatibiltiy

TABLE: general overview compatibility: 
- Data included / not included
- Size 
- Languages
- Finished / Ongoing
- Update frequency

### Data import

First, clean `data_import`:

1. Inspect `data_import`

```{r}
input_data %>% 
    select(data_import) %>%
    group_by(data_import) %>%
    summarize(records = n())
```

2. Clean:

```{r}
input_data <- 
  input_data %>% 
    mutate(data_import = recode(data_import,
      "After each trip" = "Direct",
      "In my own database on the same day as the data are collected" = "Direct",
      "Periodically, but at least within 12 months" = "< 12 months",
      "Periodically, but at least within 3 months" = "< 3 months")) 
```

### Languages

```{r}
input_data %>% select(language) %>% group_by(language) %>% summarize(records = n())
```


Create two columns: one "English" (yes/no) and one "Other" (specification of the language)

1. Create column ´english_yn´

```{r}
input_data %<>% mutate("english_yn" = case_when(
  language == "English / Dutch" |
  language == "english" |
  language == "English"  | 
  language == "English, German" | 
  language == "English/German" | 
  language == "Polish/English/Latin" | 
  language == "Russian, English" ~ "yes",
  is.na(language) ~ "unknown"
  ,
  TRUE ~ "no"))
```

2. Inspect data

```{r}
input_data %>% select(language, english_yn) %>% group_by_all() %>% summarize(records = n())
```

3. Create column ´language_other´

```{r}
input_data %<>% mutate("language_other" = case_when(
  language == "English / Dutch" ~ "Dutch",
  language == "English, German" | language == "English/German"  ~ "German",
  language == "Polish/English/Latin" ~ "Polish | Latin",
  language == "Russian, English" ~ "Russian",
  language == "French" ~ "French",
  language == "Latvian (remaks field only. the rest of fields are coded)" ~ "Latvian",
  language == "Polish" ~ "Polish" ,
  language == "Swedish" ~ "Swedish",
  is.na(language) ~ "unknown",
  TRUE ~ ""))
```

4. Inspect data

```{r}
input_data %>% 
  select(language, english_yn, language_other) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

### Finished / Ongoing


### Summary

```{r}
input_data %>% 
    select(country, esas_db_yn, nr_species, english_yn, language_other, active_yn, data_import) %>% 
  arrange(country) %>% 
  formattable() %>% 
  as_image("test.png")
```

##


GRAPH: Data included or not included in ESAS db

```{r}
esas_yn <- 
  input_data %>% 
    select(esas_db_yn) %>% 
    group_by_all() %>% 
    summarize(records = n())
```

Barplot data ([why not Pie chart](https://www.data-to-viz.com/caveat/pie.html))

```{r}
png(filename = here::here("data","figures","esas_database_yn.png"))
esas_database_yn <- 
  ggplot(esas_yn, aes(x = fct_relevel(esas_db_yn, "No", "Partially", "Yes", "Planned", "Unknown")
                      , y = records)) +
    geom_bar(colour="black",fill="#FF9933",width=0.8, stat="identity") + 
    xlab("") + ylab("Number of datasets") +
    geom_text(aes(label=records), vjust = 1.5, colour = "black") +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          axis.text.x = element_text(size = 20, hjust=1),
          axis.text.y = element_text(size = 20),
          axis.title.y = element_text(size = 20)) +
    theme(axis.text.x = element_text(angle = 45))
print(esas_database_yn)
```






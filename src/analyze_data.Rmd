---
title: "Analyze ESAS questionnaire for draft report"
author: "Lien Reyserhove"
output: html_document
---

# General settings

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

Load libraries

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(magrittr)
library(here)
library(knitr)
library(formattable)
library(sf)
library(leaflet)
library(htmltools)
library(htmlwidgets)
library(webshot)
library(kableExtra)
```

# Import data

```{r import data}
input_data <- read.delim(file = here::here("data", "intermediate", "input_data_cleaned.csv"), sep = ",")
```

Import spatial information dataset for map:

```{r import geojson}
global_countries_spatial <- st_read(here::here("./data/input/CNTR_RG_60M_2020_4326.geojson"))
```

# Paragraph 1: General project information

## Text

Total number of datasets:

```{r}
input_data %>% nrow()
```

Total number of organizations:

```{r}
input_data %>% distinct(organization_acronym) %>% count()
```

Integration in ESAs database? Summarize `esas_db_yn`:

```{r}
input_data %>% 
  select(esas_db_yn) %>% 
  group_by_all() %>% 
  summarize(records = n(),
            percentage = round(n()/nrow(input_data)*100))
```

Programme active y/n? Summarize `active_yn`:

```{r}
input_data %>% 
  select(active_yn) %>% 
  group_by_all() %>% 
  summarize(records = n(),
            percentage = round(n()/nrow(input_data)*100))
```


## Figure 1: Number of datasets per country

Generate `datasets_per_country`

```{r}
datasets_per_country <- 
  input_data %>% 
    select(country_clean) %>% 
    group_by(country_clean) %>% 
    summarize(n_datasets = n())
datasets_per_country
```

filter spatial information on countries of interest

```{r}
focal_countries_spatial <- 
  global_countries_spatial %>% 
    filter(NAME_ENGL %in% input_data$country_clean)
```

filter out information for Denmark and Finland:

```{r}
finland_denmark <- 
  global_countries_spatial %>% 
    filter(NAME_ENGL == "Finland" | NAME_ENGL == "Denmark")
```


Join information with `countries_spatial`

```{r}
focal_countries_spatial %<>% 
  left_join(datasets_per_country,
            by = c("NAME_ENGL" = "country_clean"))
```

Plot information:

```{r}
bins <- c(1, 2, 3, 4, 5,6)
labels <- c("1", "2", "3", "4", "5","6")
binpal <- colorBin("YlOrRd", domain = focal_countries_spatial$n_datasets, bins = bins)

figure_1 <-
  leaflet(focal_countries_spatial) %>%
  setView(lng = 9,
          lat = 51,
          zoom = 3.75) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~binpal(n_datasets),
    weight = 2,
    opacity = 1,
    color = "grey",
    dashArray = "3",
    fillOpacity = 1,
    label = ~htmlEscape(n_datasets)) %>%
  addPolygons(data = filter(global_countries_spatial, NAME_ENGL == "Finland"), 
              weight = 2,
              opacity = 1,
              color = "grey",
              dashArray = "3",
              fillOpacity = 1,
              fillColor = "black") %>% 
  addPolygons(data = filter(global_countries_spatial, NAME_ENGL == "Denmark"), 
              weight = 2,
              opacity = 1,
              color = "grey",
              dashArray = "3",
              fillOpacity = 1,
              fillColor = "grey") %>% 
  addLegend("bottomright",
            pal = binpal, values = ~n_datasets,
            title = "number of SAS datasets",
            opacity = 1,
            labFormat = function(type, cuts, p)
              {paste0(labels)})
figure_1
```

Save html via Export -> Save as web page or via saveWidget:

```{r}
saveWidget(figure_1,
           "figure_1.html",
           selfcontained = TRUE)
```

```{r}
webshot("figure_1.html",
        file = "../data/processed/figure_1.png",
        cliprect = "viewport")
```

## Table 1: General project information

This table discusses the following dataset properties:

- Dataset ID
- Country
- Organization (acronym)
- Programme name and/or acronym
- active (yes/no)
- esas database (yes/no)

```{r}
table_1 <- 
  input_data %>%
      select(dataset_id, country_clean, organization_acronym, programme_acronym, esas_db_yn, active_yn) %>% 
  rename(`Dataset ID` = dataset_id) %>%
  rename(`Country` = country_clean,
         `Organization (acronym)` = organization_acronym,
         `Programme name and/or acronym` = programme_acronym,
         `ESAS database (y/n)` = esas_db_yn,
         `Active (y/n)` = active_yn) %>% 
      arrange(`Country`)
kbl(table_1)
```

Define formatter:

```{r}
database_yn_formatter <-
  formatter("span",
     style = 
     x ~ style(color = ifelse(x == "Yes" |
                              x == "Partially" | 
                              x == "Planned", "green",
                                ifelse(x == "No", "red", "grey"))),
     x ~ icontext(ifelse(x == "Yes", "ok",
                    ifelse(x == "No", "remove",
                      ifelse(x == "Planned", "time", 
                        ifelse(x == "Unknown", "-", "")))),
                  
                  ifelse(x == "Yes", "Yes",
                    ifelse(x == "No", "No", 
                      ifelse(x == "Partially", "%", 
                        ifelse(x == "Planned", "", "?"))))
                  ),
                 "font_size" = 40)


yn_formatter <-
  formatter("span",
            style = 
              x ~ style(color = ifelse(x == "Yes", "green", 
                                       ifelse(x == "No", "red", "grey"))),
              x ~ icontext(ifelse( x == "Yes", "ok", 
                                   ifelse(x == "No", "remove", "minus")),
                           ifelse(x == "Yes", "Yes",
                                  ifelse(x == "No", "No", ""))),
            "font_size" = 40)
```

```{r}
formattable(table_1,
            align = c("l","l","l","l", "c", "c"),
            list(
              `ESAS database (y/n)` = database_yn_formatter,
              `Active (y/n)` = yn_formatter))%>% 
  as.htmlwidget(width = "1200px") %>%
  saveWidget("table_1.html", selfcontained = TRUE)
```

```{r}
webshot("table_1.html",
        file = "table_1.png",
        cliprect = "viewport")
```

# Paragraph 2: Data content

This table should include:

- Nr of occurrences 
- Geographical coverage
- Taxonomic Coverage
- Platform

## Clean data

### Dataset size

```{r}
input_data %>% 
  select(nr_occurrences) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

Clean values:

```{r}
input_data %<>% 
  mutate(nr_occurrences_clean = recode(nr_occurrences,
    "10.000 - 100.000" = "10.000-100.000",
    "100.000 - 1.000.000" = "100.000-1.000.000",
    "Unknown" = ""))
```

Compare `nr_occurrences` with `nr_occurrences_clean`

```{r}
input_data %>% 
  select(nr_occurrences, nr_occurrences_clean) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

Define `nr_occurrences_clean` as ordered factor:

```{r}
input_data %<>% 
  mutate(nr_occurrences_clean = 
           factor(nr_occurrences_clean,
                  levels = c("1-10.000", "10.000-100.000", "100.000-1.000.000", ">1.000.000"))) %>% 
  mutate(nr_occurrences_clean = fct_explicit_na(nr_occurrences_clean, ""))
```


### Geographical scope

Inspect values

```{r}
input_data %>% 
  select(geographical_scope) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

Make new columns `OSPAR`, `HELCOM` and `Other`:

```{r}
input_data %<>% 
  mutate(ospar = recode(geographical_scope,
    "Arctic waters (OSPAR Region I)" = "I",
    "Arctic waters (OSPAR Region I), Greater North Sea (OSPAR Region II), Bay of Biscay and Iberian Coast (OSPAR Region IV), Wider Atlantic (OSPAR Region V), Tropics" = "I,II,IV,V",
   "Baltic Sea" = "",
   "Baltic Sea, The Gulf of Finland of Baltic Sea" = "",
   "Bay of Biscay and Iberian Coast (OSPAR Region IV)" = "IV",
   "Bay of Biscay and Iberian Coast (OSPAR Region IV), Only shelf Spanish waters in the N and NW of the Iberian Coast" = "IV",
   "Bay of Biscay and Iberian Coast (OSPAR Region IV), Wider Atlantic (OSPAR Region V)" = "IV,V",
   "Celtic Seas (OSPAR Region III)" = "III",
   "East Mediterranean" = "",
   "Greater North Sea (OSPAR Region II)" = "II",
   "Greater North Sea (OSPAR Region II), Baltic Sea" = "II",
   "Greater North Sea (OSPAR Region II), Celtic Seas (OSPAR Region III)" = "II,III",
   "Greater North Sea (OSPAR Region II), Celtic Seas (OSPAR Region III), Bay of Biscay and Iberian Coast (OSPAR Region IV)" = "II,III,IV",
   "The Irish EEZ" = "II,III",
   "UK waters" = "II,III"
    ))
```

Helcom areas:

```{r}
input_data %<>% 
  mutate(baltic_sea = recode(geographical_scope,
    "Arctic waters (OSPAR Region I)" = "",
    "Arctic waters (OSPAR Region I), Greater North Sea (OSPAR Region II), Bay of Biscay and Iberian Coast (OSPAR Region IV), Wider Atlantic (OSPAR Region V), Tropics" = "",
   "Baltic Sea" = "yes",
   "Baltic Sea, The Gulf of Finland of Baltic Sea" = "yes",
   "Bay of Biscay and Iberian Coast (OSPAR Region IV)" = "",
   "Bay of Biscay and Iberian Coast (OSPAR Region IV), Only shelf Spanish waters in the N and NW of the Iberian Coast" = "",
   "Bay of Biscay and Iberian Coast (OSPAR Region IV), Wider Atlantic (OSPAR Region V)" = "",
   "Celtic Seas (OSPAR Region III)" = "",
   "East Mediterranean" = "",
   "Greater North Sea (OSPAR Region II)" = "",
   "Greater North Sea (OSPAR Region II), Baltic Sea" = "yes",
   "Greater North Sea (OSPAR Region II), Celtic Seas (OSPAR Region III)" = "",
   "Greater North Sea (OSPAR Region II), Celtic Seas (OSPAR Region III), Bay of Biscay and Iberian Coast (OSPAR Region IV)" = "",
   "The Irish EEZ" = "",
   "UK waters" = ""
    ))
```

Inspect new values:

```{r}
input_data %>% 
  select(geographical_scope, ospar, baltic_sea) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

Seperate geographical locations on comma:

```{r}
geographical_scope_data <-
  input_data %<>% 
    separate(geographical_scope, 
             into = c("scope_1", "scope_2", "scope_3", "scope_4", "scope_5"),
             sep = ",")
```

From wide to long dataset:

```{r}
geographical_scope_data <- 
  geographical_scope_data %>%  
    gather(
      key = "key",
      value = "scope",
      "scope_1", "scope_2", "scope_3", "scope_4", "scope_5",
      na.rm = T) %>% 
  mutate(scope = trimws(scope, "left")) %>% 
  select(dataset_id, key, scope)
```

Summarize scope

```{r}
geographical_scope_data %>% 
  select(scope) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

Recode values:

```{r}
geographical_scope_data %<>% 
  mutate(scope_clean = recode(scope, 
    "Arctic waters (OSPAR Region I)" = "OSPAR I",
    "Bay of Biscay and Iberian Coast (OSPAR Region IV)" = "OSPAR IV",
    "Celtic Seas (OSPAR Region III)" = "OSPAR III",
    "Greater North Sea (OSPAR Region II)" = "OSPAR II",
    "Only shelf Spanish waters in the N and NW of the Iberian Coast" = "shelf Spanish waters in N/NW Iberian Coast",
    "The Gulf of Finland of Baltic Sea" = "Gulf of Finland",
    "The Irish EEZ" = "Irish EEZ",
    "Wider Atlantic (OSPAR Region V)" = "OSPAR V"
    ))
```

```{r}
geographical_scope_data %>% 
  select(scope, scope_clean) %>% 
  group_by_all() %>% 
  summarize(n = n(),
            `%` = round(n()/nrow(geographical_scope_data)*100)) 
```

From long to wide dataset:

```{r}
geographical_scope_data %<>% 
  select(-scope) %>% 
  spread(key,value = scope_clean)
```

Concate to one column `geographical_scope_clean`

```{r}
geographical_scope_data <-
  geographical_scope_data %>%
    unite(col = geographical_scope_clean, 
          scope_1, scope_2, scope_3, scope_4, scope_5, 
          na.rm = T, sep = ", ") 
```

Add `geographic_scope_clean` to `input_data`:

```{r}
input_data <- 
  input_data %>% 
    left_join(geographical_scope_data, 
              by = "dataset_id") %>% 
    select(-c(scope_1,scope_2,scope_3,scope_4,scope_5))
```

### Taxonomic Coverage

Inspect values:

```{r}
input_data %>% 
  select(taxonomic_scope) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

Seperate into `birds_yn`, `marine_mammals_yn`, `other`:

```{r}
input_data %<>%
  separate(taxonomic_scope,
             into = c("birds_yn", "marine_mammals_yn", "other"),
             sep = ", ",
             remove = FALSE)
```

Clean data:
- recode to yes/no for birds and marine mammals or empty if NA
- Clean `other` field

```{r}
input_data %<>% 
  mutate(other = case_when(
    birds_yn == "Multispecies" ~ "Multispecies", # add multispecies information to `other`
    TRUE ~ other)) %>% 
  mutate(birds_yn = "yes") %>%  # all datasets have birds
  mutate(marine_mammals_yn = case_when(
    marine_mammals_yn == "Marine mammals" ~ "yes", TRUE ~ "")) %>% 
  mutate(other = recode(other,
    "fish and turtles" = "Fish, turtles",
    "oceanography" = "Oceanography",
    "reptiles" = "Reptiles",
    "turtle" = "Turtles",
    .missing = "")) 
```

Summarize results

```{r}
input_data %>% 
  select(taxonomic_scope, birds_yn, marine_mammals_yn, other) %>% 
  group_by_all() %>% 
  summarize(records = n())
```

### Temporal scope

Inspect `start_year` and `end_year`

```{r}
input_data %>% 
  select(start_year, end_year) %>% 
  group_by_all() %>% 
  summarize(n = n())
```

Recode `ongoing` to `2020` in `end_year

```{r}
input_data %<>% 
  mutate(end_year = recode(end_year, "ongoing" = "2020"))
```

Concatenate to `temporal_scope`:

```{r}
input_data %<>% 
  mutate(temporal_scope = paste(start_year, end_year, sep = "-"))
```

```{r}
input_data %>% 
  select(start_year, end_year, temporal_scope) %>% 
  group_by_all() %>% 
  summarize(n = n())
```

### Platform

```{r}
input_data %>% 
  select(platform) %>% group_by_all() %>% summarize(n = n())
```

Generate two columns: `ship-based` and `aerial`

```{r}
input_data <- 
  input_data %>% 
    mutate(ship_based = case_when(
      platform == "Ship-based" |
        platform == "Ship-based, Aerial" ~ "yes",
      TRUE ~ "")) %>% 
    mutate(aerial = case_when(
       platform == "Aerial" |
        platform == "Ship-based, Aerial" ~ "yes",   
       TRUE ~ ""))
```

## Table 2: Data content

This table should include:

- Nr of occurrences 
- Geographical coverage
- Taxonomic Coverage
- Platform

```{r}
table_2 <-
input_data %>% 
  select(dataset_id, nr_occurrences_clean, temporal_scope, ospar, baltic_sea, 
         marine_mammals_yn, aerial, ship_based) %>% 
  rename(
    `Dataset ID` = dataset_id,
    `Nr of occurrences` = nr_occurrences_clean,
    `Temporal scope` = temporal_scope,
    `OSPAR region` = ospar,
    `Baltic Sea` = baltic_sea,
    `Marine mammals` = marine_mammals_yn,
    `Plane` = aerial,
    `Ship` = ship_based) %>% 
  arrange(`Dataset ID`)
  
```

Define formatters:

```{r}
y_formatter <-
  formatter("span",
            style = 
              x ~ style(color = ifelse(x == "yes", "green", "")),
              x ~ icontext(ifelse(x == "yes", "ok", ""),
                           ifelse(x == "Yes", "Yes", "")))
```


```{r}
formattable(table_2, 
            align = c("l", "r", "c", "c", "c", "c", "c"),
            list(
    `Nr of occurrences`  = color_tile("yellow", "red"),
    `Baltic Sea` = y_formatter,
    `Marine mammals` = y_formatter,
    `Plane` = y_formatter,
    `Ship` = y_formatter)) %>% 
  as.htmlwidget(width = "1200px") %>%
  saveWidget("table_2.html", selfcontained = TRUE)
```


```{r}
webshot("table_2.html",
        file = "table_2.png",
        cliprect = "viewport")
```

## Text

Summarize amount of programmes that include marine mammals:

```{r}
input_data %>% 
  select(marine_mammals_yn) %>% 
  group_by(marine_mammals_yn) %>% 
  summarize(records = n(),
            percentage = round(n()/nrow(input_data)*100))
```



# Paragraph 3: Constraints for sharing data

## Clean data

### Sharing interest

Screent content of `sharing_interest_yn`:

```{r}
input_data %>%
  select(sharing_interest_yn) %>% 
  group_by(sharing_interest_yn) %>% 
  summarize(records = n(),
            `?` = n()/nrow(input_data)*100)
```

No cleaning required

### Financial constraints

Screent content of `financial_constraints_yn`:

```{r}
input_data %>%
  select(financial_constraints_yn) %>% 
  group_by(financial_constraints_yn) %>% 
  summarize(records = n(),
            `?` = n()/nrow(input_data)*100)
```

In table 3, it is better to reformulate to `financial_condition` which should be `OK`(thus `financial_constraints`=`No`), `NOK`(thus `financial_constraints`=`Yes`) or `Unknown`

```{r}
input_data %<>% 
  mutate(financial_condition = case_when(
    financial_constraints_yn == "Yes" ~ "NOK",
    financial_constraints_yn == "No" ~ "OK",
    financial_constraints_yn == "Unknown" ~ "-"))
```

### Legal constraints

```{r}
input_data %>%
  select(legal_constraints_yn) %>% 
  group_by(legal_constraints_yn) %>% 
  summarize(records = n(),
            `?` = n()/nrow(input_data)*100)
```

In table 3, it is better to reformulate to `legal_condition` which should be `OK`(thus `legal_constraints`=`No`), `NOK`(thus `legal_constraints`=`Yes`) or `Unknown`

```{r}
input_data %<>% 
  mutate(legal_condition = case_when(
    legal_constraints_yn == "Yes" ~ "NOK",
    legal_constraints_yn == "No" ~ "OK",
    legal_constraints_yn == "Unknown" ~ "-"))
```

## Table 3

This table discusses the following dataset properties:

- Sharing interest (Y/n)
- Financial constraints (y/n)
- Legal constraints (y/n)


For this table we use the `formattable` package. FOr this, we need to define the formatters for `y/n` and `OK/NOK` first:

Define formatters:

```{r}
yn_formatter <-
  formatter("span",
            style = 
              x ~ style(color = ifelse(x == "Yes", "green", 
                                       ifelse(x == "No", "red", "grey"))),
              x ~ icontext(ifelse( x == "Yes", "ok", 
                                   ifelse(x == "No", "remove", "minus")),
                           ifelse(x == "Yes", "Yes",
                                  ifelse(x == "No", "No", ""))),
            "font_size" = 40)

OK_NOK_formatter <-
  formatter("span",
            style = 
              x ~ style(color = ifelse(x == "OK", "green", 
                                       ifelse(x == "NOK", "red", "grey"))),
              x ~ icontext(ifelse( x == "OK", "ok", 
                                   ifelse(x == "NO", "remove", "minus")),
                           ifelse(x == "OK", "OK",
                                  ifelse(x == "NOK", "NOK", ""))),
            "font_size" = 40)
```

Generate table 3:

```{r}
table_3 <- 
  input_data %>% 
    select(dataset_id, sharing_interest_yn, financial_condition, legal_condition) %>%
    rename(`Dataset ID` = dataset_id,
           `Sharing interest (y/n)` = sharing_interest_yn,
           `financial condition (OK/NOK))` = financial_condition,
           `legal condition (OK/NOK)` = legal_condition) %>% 
    arrange(`Dataset ID`) 
```


```{r}
formattable(table_3,
            align = c("l","c","c","c"),
            list(
              `Sharing interest (y/n)` = yn_formatter,
              `financial condition (OK/NOK))` = OK_NOK_formatter,
              `legal condition (OK/NOK)` = OK_NOK_formatter)) %>% 
  as.htmlwidget(width = "1200px") %>%
  saveWidget("table_3.html", selfcontained = TRUE)
```


```{r}
webshot("table_3.html",
        file = "table_3.png",
        cliprect = "viewport")
```

# Other variables of interest

### Data storage

Inspect content 

```{r, eval=FALSE}
input_data %>% 
    select(data_storage) %>% 
    group_by(data_storage) %>% 
    summarize(records = n())
```

Some cleaning steps:

- Change `Relational database (Postgres, MySQL, etc.)` to `Relational database` as we will seperate on `,` later:

```{r}
input_data <-
  input_data %>% mutate(data_storage = recode(data_storage,
    "Relational database (Postgres, MySQL, etc.)" = "Relational database",
    "Relational database (Postgres, MySQL, etc.), CSV files" = "Relational database, CSV files",
    "Relational database (Postgres, MySQL, etc.), Microsoft Excel" = "Relational database, Microsoft Excel"))
```

- Seperate `data_storage` into different units:

```{r}
data_storage <- 
  input_data %>% separate(col = data_storage, 
                            into = c("storage_1", "storage_2"),
                            sep = ",")
```

- From wide to long dataset:

```{r}
data_storage <-
  data_storage %>% 
  gather(key = key, value = value, storage_1: storage_2, na.rm = TRUE, factor_key = TRUE) %>% 
  select(key, value) %>% 
  mutate(value = str_trim(value, side = "left")) %>%    # trim whitespace
  mutate(value = recode(value, 
    "But since 2015 we are collecting data using electronic devices. A Cybertracker based App was built. Data is needed to be imported to Paradox though." = "Paradox"))  %>% # Recode long sentence to `Paradox` 
  mutate(value = factor(value, levels = c("CSV files", "Microsoft Excel", "Microsoft Access", "Paradox", "Relational database")))
```

- Count records:

```{r}
data_storage %>% 
    select(value) %>% 
    group_by(value) %>% 
    summarize(records = n(),
              percentage = n()/nrow(input_data)*100)
data_storage
```

# Discussion per country

Define function to retrieve information in discussion section

```{r}
summary_per_datasetid <-
  function(id){
    input_data %>% filter(dataset_id == id) %>% 
      mutate(start_year = factor(start_year)) %>% 
      select(dataset_id,
        email_address,
        country_clean,
        organization_acronym,
        programme_acronym,
        role,
        programm_lead,
        short_description,
        active_yn,
        start_year,
        end_year,
        taxonomic_scope,
        geographical_scope_clean,
        nr_occurrences_clean,
        platform,
        data_storage,
        esas_db_yn,
        remarks,
        sharing_interest_yn,
        financial_constraints_yn,
        expected_costs,
        legal_constraints_yn,
        sharing_conditions,
        other_relevant_remarks,
        other_sas_data) %>% 
      rownames_to_column() %>% 
      pivot_longer(-rowname, names_to = "column") %>% 
      select(-rowname) %>% 
      kbl() %>% 
      kable_styling(bootstrap_options = c("striped", "hover"))
      }
```

Function to retrieve organization codes per country:

```{r}
datasetid_per_country <- 
  function(country_name){
    input_data %>% 
      filter(country_clean == country_name) %>% 
      select(dataset_id)
    }
```

Retrieve dataset id's for a specific country:

```{r}
datasetid_per_country("Netherlands")
```

Summarize information for a specific `dataset_id`:

```{r}
summary_per_datasetid("NLD-WUR")
```




